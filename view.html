<!DOCTYPE html>
<html>
<head>
    <title>Network Live Map</title>
    <style>
        body { margin: 0; background: #281536; color: white; font-family: 'Segoe UI', sans-serif; }
        
        header { 
            background: #522d6d; padding: 15px 40px; display: flex; align-items: center; 
            border-bottom: 2px solid #CDDE00; position: fixed; top: 0; left: 0; width: 100%; 
            box-sizing: border-box; z-index: 1000; 
        }

        #map-container { 
            width: 3600px; height: 2000px; background: url('map.svg') no-repeat; 
            background-size: contain; position: relative; margin: 120px 40px 60px 40px; 
            border: 1px solid #333; 
        }

        #path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
        .route-line { fill: none; stroke: rgba(246, 240, 252, 0.3); stroke-width: 1px; stroke-dasharray: 4; }
        
        .city-dot {
            position: absolute; width: 8px; height: 8px; background: #CDDE00;
            border-radius: 50%; z-index: 15; transform: translate(-50%, -50%);
        }

        .city-label { 
            position: absolute; font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.7); 
            padding: 2px 4px; border-radius: 3px; z-index: 10; transform: translateX(-50%);
        }
        
        .plane { 
            position: absolute; font-size: 24px; z-index: 20; 
            margin-left: -12px; margin-top: -12px; pointer-events: none; 
            text-shadow: 0 0 10px #CDDE00;
            /* ONLY animate position. Do NOT animate transform/rotation. */
            transition: left 6s linear, top 6s linear; 
            will-change: left, top;
        }
    </style>
</head>
<body>
    <header>
        <div class="branding"><h1>Network Live Map</h1><p>Developed & Designed by Abdulaziz Salamah</p></div>
    </header>

    <div id="map-container"><svg id="path-svg"></svg></div>

    <script>
        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxCNjNehg9DqxbLY8kFtRaTVftJYot8Lk_QcxyofrwcmvU_BuuRnEZLVlHeQxGeD9Ns/exec";
        const container = document.getElementById('map-container');
        const pathSvg = document.getElementById('path-svg');

async function drawNetwork() {
            try {
                const response = await fetch(SHEET_URL);
                const routes = await response.json();
                
                container.querySelectorAll('.city-label, .plane, .city-dot').forEach(el => el.remove());
                pathSvg.innerHTML = '';

                routes.forEach(r => {
                    // 1. Draw Lines and Cities
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("class", "route-line");
                    line.setAttribute("x1", r.ax); line.setAttribute("y1", r.ay);
                    line.setAttribute("x2", r.bx); line.setAttribute("y2", r.by);
                    pathSvg.appendChild(line);
                    addCity(r.a, r.ax, r.ay);
                    addCity(r.b, r.bx, r.by);

                    // 2. Create Plane
                    const plane = document.createElement('div');
                    plane.className = 'plane';
                    plane.innerHTML = '✈️';
                    // Start at City A facing B
                    plane.style.left = r.ax + 'px';
                    plane.style.top = r.ay + 'px';
                    plane.style.transform = 'rotate(45deg)'; 
                    container.appendChild(plane);

                    // 3. The Chained Animation Logic
                    function startCycle() {
                        // PHASE 1: Fly to B (6 seconds)
                        plane.style.left = r.bx + 'px';
                        plane.style.top = r.by + 'px';

                        // After 6 seconds (Arrival at B)
                        setTimeout(() => {
                            // PHASE 2: Rotate at B and wait (2 seconds)
                            plane.style.transform = 'rotate(225deg)';

                            // After 2 seconds of waiting
                            setTimeout(() => {
                                // PHASE 3: Fly back to A (6 seconds)
                                plane.style.left = r.ax + 'px';
                                plane.style.top = r.ay + 'px';

                                // After 6 seconds (Arrival at A)
                                setTimeout(() => {
                                    // PHASE 4: Rotate at A and wait (2 seconds)
                                    plane.style.transform = 'rotate(45deg)';

                                    // After 2 seconds, restart the whole cycle
                                    setTimeout(startCycle, 2000);

                                }, 6000);
                            }, 2000);
                        }, 6000);
                    }

                    // Start the loop with a random delay so they aren't all in sync
                    setTimeout(startCycle, Math.random() * 2000);
                });
            } catch (error) { console.error("Cloud Error:", error); }
        }

        function addCity(name, x, y) {
            const dot = document.createElement('div');
            dot.className = 'city-dot'; dot.style.left = x + 'px'; dot.style.top = y + 'px';
            container.appendChild(dot);
            const div = document.createElement('div');
            div.className = 'city-label'; div.style.left = x + 'px'; div.style.top = (y + 12) + 'px'; div.innerText = name; 
            container.appendChild(div);
        }

        drawNetwork();
    </script>
</body>
</html>
