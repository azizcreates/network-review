<!DOCTYPE html>
<html>
<head>
    <title>Network Live Map</title>
    <style>
        body { margin: 0; background: #281536; color: white; font-family: 'Segoe UI', sans-serif; overflow: auto; }
        
        header {
            background: #522d6d;
            padding: 15px 40px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid #CDDE00;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo { height: 50px; width: auto; margin-right: 20px; display: block; }

        .branding h1 { margin: 0; font-size: 24px; color: #CDDE00; }
        .branding p { margin: 0; font-size: 13px; color: #ffffff; opacity: 0.8; }

        #map-container { 
            width: 3600px; 
            height: 2000px; 
            background: url('map.svg') no-repeat;
            background-size: contain;
            position: relative;
            margin: 60px 40px;
            border: 1px solid #333;
        }

        #path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
        .route-line { fill: none; stroke: rgba(205, 222, 0, 0.2); stroke-width: 1px; stroke-dasharray: 4; }

        /* City Dot Styling */
        .city-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #CDDE00;
            border-radius: 50%;
            z-index: 15;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #CDDE00;
        }

        .city-label { 
            position: absolute; 
            font-size: 11px; 
            font-weight: bold; 
            background: rgba(0,0,0,0.8); 
            padding: 2px 6px; 
            border-radius: 3px; 
            z-index: 10; 
            white-space: nowrap; 
            transform: translateX(-50%); /* Center text under dot */
        }
        
        .plane { 
            position: absolute; 
            font-size: 24px; 
            z-index: 20; 
            margin-left: -12px; 
            margin-top: -12px; 
            pointer-events: none;
            text-shadow: 0 0 10px #CDDE00;
        }

        @keyframes flyToB {
            0% { transform: translate(var(--x1), var(--y1)) rotate(var(--angle)); }
            100% { transform: translate(var(--x2), var(--y2)) rotate(var(--angle)); }
        }
        @keyframes flyToA {
            0% { transform: translate(var(--x2), var(--y2)) rotate(var(--rev-angle)); }
            100% { transform: translate(var(--x1), var(--y1)) rotate(var(--rev-angle)); }
        }
    </style>
</head>
<body>

    <header>
        <img src="logo.svg" alt="Logo" class="logo">
        <div class="branding">
            <h1>Network Live Map</h1>
            <p>Developed & Designed by Abdulaziz Salamah</p>
        </div>
    </header>

    <div id="map-container">
        <svg id="path-svg"></svg>
    </div>

    <script>
        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxO6arOMafeKrrDuRiEwc4p2bDkqI6L9e3yfSEuPDbZ2649YGmpf2YnY7ybJPMiTCM3/exec";
        const container = document.getElementById('map-container');
        const pathSvg = document.getElementById('path-svg');
        const SPEED = 80;

        async function drawNetwork() {
            try {
                const response = await fetch(SHEET_URL);
                const routes = await response.json();
                
                // Clear old elements (labels, planes, and dots)
                container.querySelectorAll('.city-label, .plane, .city-dot').forEach(el => el.remove());
                pathSvg.innerHTML = '';

                routes.forEach(r => {
                    // Draw Line
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("class", "route-line");
                    line.setAttribute("x1", r.ax); line.setAttribute("y1", r.ay);
                    line.setAttribute("x2", r.bx); line.setAttribute("y2", r.by);
                    pathSvg.appendChild(line);

                    // Add Cities (Dot + Label)
                    addCity(r.a, r.ax, r.ay);
                    addCity(r.b, r.bx, r.by);

                    // Animation Logic
                    const dx = r.bx - r.ax;
                    const dy = r.by - r.ay;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const duration = dist / SPEED;
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    const plane = document.createElement('div');
                    plane.className = 'plane';
                    plane.innerHTML = '✈️';
                    plane.style.setProperty('--x1', r.ax + 'px');
                    plane.style.setProperty('--y1', r.ay + 'px');
                    plane.style.setProperty('--x2', r.bx + 'px');
                    plane.style.setProperty('--y2', r.by + 'px');
                    plane.style.setProperty('--angle', (angle + 45) + 'deg');
                    plane.style.setProperty('--rev-angle', (angle + 225) + 'deg');
                    container.appendChild(plane);

                    function animate() {
                        plane.style.animation = `flyToB ${duration}s linear forwards`;
                        setTimeout(() => {
                            setTimeout(() => {
                                plane.style.animation = `flyToA ${duration}s linear forwards`;
                                setTimeout(() => { setTimeout(animate, 1000); }, duration * 1000);
                            }, 1000);
                        }, duration * 1000);
                    }
                    setTimeout(animate, Math.random() * 2000);
                });
            } catch (error) { console.error("Fetch Error:", error); }
        }

        function addCity(name, x, y) {
            // Avoid adding duplicate dots for the same city coordinate
            const id = `dot-${x}-${y}`;
            if (document.getElementById(id)) return;

            // Create Dot
            const dot = document.createElement('div');
            dot.className = 'city-dot';
            dot.id = id;
            dot.style.left = x + 'px';
            dot.style.top = y + 'px';
            container.appendChild(dot);

            // Create Label
            const lbl = document.createElement('div');
            lbl.className = 'city-label';
            lbl.style.left = x + 'px';
            lbl.style.top = (y + 12) + 'px'; // Positioned just below the dot
            lbl.innerText = name;
            container.appendChild(lbl);
        }

        drawNetwork();
        setInterval(drawNetwork, 60000);
    </script>
</body>
</html>
